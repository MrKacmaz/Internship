<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"
        integrity="sha384-SR1sx49pcuLnqZUnnPwx6FCym0wLsk5JZuNx2bPPENzswTNFaQU1RDvt3wT4gWFG"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.min.js"
        integrity="sha384-j0CNLUeiqtyaRmlzUHCPZ+Gy5fQu0dQ6eZ/xAww941Ai1SxSY+0EQqNXNE6DZiVc"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <!-- Sweet alert src -->
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</head>

<body>
    <div class="buy">

        <div class="select">

            <select id="coinSelectBox" class="form-select" aria-label="Default select example">
                <option selected>Open Coin Menu</option>
            </select>

        </div>

        <div class="valueInput">

            <div class="input-group mb-3">
                <span class="input-group-text" id="basic-addon1">Rate</span>
                <input id="rateInput" type="text" class="form-control">
            </div>

            <div class="input-group mb-3">
                <span class="input-group-text" id="basic-addon1">Piece</span>
                <input id="pieceInput" type="text" class="form-control">
            </div>

        </div>

        <div class="buttons">
            <div class="buyButton">
                <button type="button" class="btn btn-primary" onclick="buyOperation()">Buy</button>
            </div>
        </div>

    </div>

    <div class="showTable">

        <table class="table">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Coin name</th>
                    <th scope="col">Coin Rate</th>
                    <th scope="col">Piece</th>
                    <th scope="col">Total</th>
                    <th scope="col">Operations</th>
                </tr>
            </thead>
            <tbody id="tbody">

            </tbody>

            <tfoot>
                <tr>
                    <td>SUM</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>
                        <button type="button" class="btn btn-primary" onclick="buyCoinsBtn()">Buy</button>
                    </td>
                </tr>
            </tfoot>
        </table>

    </div>


    <script>
        var selectedCoinName, selectedCoinRate, piece, currentSpending, counter = 0, claimAllCoinMoney = 0;
        var totalCoinsArray = new Array();
        var btcFinal, etcFinal, adaFinal;

        $(document).ready(function () {
            showAllCoin();
        });

        function showAllCoin() {

            // GET BTC
            $.ajax({
                url: 'https://rest.coinapi.io/v1/exchangerate/BTC/USD?apikey=67D95600-D20A-477C-BFB3-035151CD7855',
                type: 'GET',
                headers: {
                    'apikey': '67D95600-D20A-477C-BFB3-035151CD7855'
                },
                data: {

                },
                beforeSend: function () {

                },
                success: function (data) {
                    console.log("BTC = " + data.rate);
                    $('#coinSelectBox').append($('<option >', {
                        value: data.rate,
                        text: data.asset_id_base,
                        id: data.asset_id_base,
                        name: data.asset_id_base
                    }));
                    btcFinal = data.rate;
                }
            });

            // GET ETC
            $.ajax({
                url: 'https://rest.coinapi.io/v1/exchangerate/ETC/USD?apikey=67D95600-D20A-477C-BFB3-035151CD7855',
                type: 'GET',
                headers: {
                    'apikey': '67D95600-D20A-477C-BFB3-035151CD7855'
                },
                data: {

                },
                beforeSend: function () {

                },
                success: function (data) {
                    console.log("ETC = " + data.rate);
                    $('#coinSelectBox').append($('<option >', {
                        value: data.rate,
                        text: data.asset_id_base,
                        id: data.asset_id_base,
                        name: data.asset_id_base
                    }));
                    etcFinal = data.rate;
                }
            });

            // GET ADA
            $.ajax({
                url: 'https://rest.coinapi.io/v1/exchangerate/ADA/USD?apikey=67D95600-D20A-477C-BFB3-035151CD7855',
                type: 'GET',
                headers: {
                    'apikey': '67D95600-D20A-477C-BFB3-035151CD7855'
                },
                data: {

                },
                beforeSend: function () {

                },
                success: function (data) {
                    console.log("ADA = " + data.rate);
                    $('#coinSelectBox').append($('<option >', {
                        value: data.rate,
                        text: data.asset_id_base,
                        id: data.asset_id_base,
                        name: data.asset_id_base
                    }));
                    adaFinal = data.rate;
                }
            });
        }


        // Select box operations
        $('#coinSelectBox').change(function () {
            $("#rateInput").val($(this).val());
            $("#rateInput").attr("disabled", true);
            selectedCoinRate = $(this).val();
            selectedCoinName = $(this).find('option:selected').attr("name");
        });


        function buyOperation() {
            piece = $("#pieceInput").val();
            currentSpending = piece * selectedCoinRate;
            var currentCoinArray = [selectedCoinName, selectedCoinRate, piece, currentSpending];
            totalCoinsArray.push(currentCoinArray);
            clearInputs();
            addRowToTable(currentCoinArray);
        }

        function clearInputs() {
            $("input").val("");
            $("input").attr("disabled", false);
        }

        function addRowToTable(currentCoinArray) {
            claimAllCoinMoney += parseInt(currentCoinArray[3]);
            $("#tbody").append(
                '<tr id = tr-' + counter + '>' +
                '<td id= ' + counter + '>' + (counter + 1) + '</td>' +
                '<td id= ' + counter + '>' + currentCoinArray[0] + '</td>' +
                '<td id= ' + counter + '>' + parseFloat(currentCoinArray[1]).toFixed(2) + '</td>' +
                '<td id= ' + counter + '>' + currentCoinArray[2] + '</td>' +
                '<td id= ' + counter + '>' + parseFloat(currentCoinArray[3]).toFixed(2) + '</td>' +
                '<td id= sell-' + counter + '>' + '<button type="button" class="btn btn-warning" onclick="coinSellBtn(this)">Sell</button>' + '</td>' +
                '</tr>'
            );
            counter++;
        }

        function buyCoinsBtn() {
            swal("Payment Successful!", "Thank you for using MrKacmaz Coin System!", "success");
        }

        function coinSellBtn(uniqueCounter) {
            swal({
                title: "Are you sure?",
                text: "Once you sell, you will not be able to recover this coin!",
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
                .then((willDelete) => {
                    if (willDelete) {

                        extractionProcess(uniqueCounter);

                        // delet selected row
                        let rowInSweetAlert = uniqueCounter.parentNode.parentNode;
                        rowInSweetAlert.parentNode.removeChild(rowInSweetAlert);
                        swal("Successful! Your coin has been sold!", {
                            icon: "success",
                        });
                    } else {
                        swal("Your coin is safe!");
                    }
                });
        }

        function extractionProcess(uniqueCounter) {
            showAllCoin();
            // the selected amount is subtracted from all money 
            let selectedCoinSellPrice = $(uniqueCounter).parent().parent().children().eq(4).text();
            let selectedCoinSellPiece = $(uniqueCounter).parent().parent().children().eq(3).text();
            let selectedCoinSellName = $(uniqueCounter).parent().parent().children().eq(1).text();

            switch (selectedCoinSellName) {

                case "BTC":
                    claimAllCoinMoney = claimAllCoinMoney - (btcFinal * selectedCoinSellPiece);
                    break;

                case "ETC":
                    claimAllCoinMoney -= (etcFinal * selectedCoinSellPiece);
                    break;

                case "ADA":
                    claimAllCoinMoney -= (adaFinal * selectedCoinSellPiece);
                    break;

                default:
                    swal("ERROR!", "extractionProcess() switch case error", "error");
                    break;
            }
        }
    </script>
</body>

</html>